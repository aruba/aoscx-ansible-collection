---
- debug:
    msg: START aoscx_vrf rd (create/modify) integration tests on connection={{ ansible_connection }}

- import_tasks: _remove_config.yaml

- block:

# - import_tasks: _populate.yaml

  - name: Create vrf with RD
    register: result
    aoscx_vrf:
      name: ansible_vrf_test_1
      rd: "23:23"
      state: create

  - name: Get vrf facts
    register: vrf_facts
    aoscx_facts:
      gather_network_resources:
        - vrfs

  - name: Assert if vrf is not created with rd
    ansible.builtin.assert:
     that:
        - "'ansible_vrf_test_1' in vrf_facts.ansible_facts.ansible_network_resources.vrfs"
        - vrf_facts.ansible_facts.ansible_network_resources.vrfs.ansible_vrf_test_1.rd == '23:23'

  - name: Create vrf with RD (idempotent)
    register: result
    aoscx_vrf:
      name: ansible_vrf_test_1
      rd: "23:23"
      state: create

  - name: Assert that the previous task was idempotent
    ansible.builtin.assert:
        that:
          - not result['changed']

# Modify
  - name: Modify vrf with RD
    register: result
    aoscx_vrf:
      name: ansible_vrf_test_1
      rd: "44:44"
      state: create

  - name: Get vrf facts
    register: vrf_facts
    aoscx_facts:
      gather_network_resources:
        - vrfs

  - name: Assert if vrf is not modifiy with rd
    ansible.builtin.assert:
      that:
        - "'ansible_vrf_test_1' in vrf_facts.ansible_facts.ansible_network_resources.vrfs"
        - vrf_facts.ansible_facts.ansible_network_resources.vrfs.ansible_vrf_test_1.rd == '44:44'

  - name: Modify vrf with RD (idempotent)
    register: result
    aoscx_vrf:
      name: ansible_vrf_test_1
      rd: "44:44"
      state: create

  - name: Assert that the previous task was idempotent
    ansible.builtin.assert:
      that:
        - not result['changed']

  always:

    - import_tasks: _remove_config.yaml
